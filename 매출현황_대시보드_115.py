# -*- coding: utf-8 -*-
"""ë§¤ì¶œí˜„í™© ëŒ€ì‹œë³´ë“œ_115.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1WOyqtD5EptoH4Uf5ZT52v-BrdJN4_tzY
"""

!pip install streamlit
!pip install streamlit_colab
!pip install streamlit-plotly-events
!pip install openpyxl
!pip install pyngrok

# Commented out IPython magic to ensure Python compatibility.
# %%writefile app.py
# 
# import streamlit as st
# import pandas as pd
# import plotly.express as px
# import io
# import numpy as np
# 
# 
# # íŽ˜ì´ì§€ ì„¤ì •
# st.set_page_config(
#     page_title="ë§¤ì¶œ ë¶„ì„ ëŒ€ì‹œë³´ë“œ",
#     layout="wide"  # ì™€ì´ë“œ ëª¨ë“œë¡œ ì„¤ì •
#     )
# 
# # ì œëª©
# st.title("ðŸ“Š ë§¤ì¶œ ë¶„ì„ ëŒ€ì‹œë³´ë“œ")
# st.info("ë¶„ì„ì„ ì‹œìž‘í•˜ë ¤ë©´ ì™¼ìª½ ì‚¬ì´ë“œë°”ì— **'ë§¤ì¶œ ë¦¬ìŠ¤íŠ¸'**ì™€ **'ë§ˆìŠ¤í„° íŒŒì¼'**ì„ ëª¨ë‘ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.")
# 
# # session_state ì´ˆê¸°í™”
# if 'current_df' not in st.session_state:
#     st.session_state.current_df = pd.DataFrame()
# 
# # 1. ì‚¬ì´ë“œë°” êµ¬ì„±
# with st.sidebar:
#     st.header("íŒŒì¼ ì—…ë¡œë“œ ë° ê¸°ê°„ ì„ íƒ")
# 
#     # ë‘ ê°œì˜ ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ ìœ„ì ¯
#     sales_file = st.file_uploader("1. ë§¤ì¶œ ë¦¬ìŠ¤íŠ¸ íŒŒì¼ ì—…ë¡œë“œ", type=["xlsx"])
#     master_file = st.file_uploader("2. ë§ˆìŠ¤í„° íŒŒì¼ ì—…ë¡œë“œ (ë§¤ì¶œì²˜, í’ˆëª© ì‹œíŠ¸ í¬í•¨)", type=["xlsx"])
# 
#     # ë‘ íŒŒì¼ì´ ëª¨ë‘ ì—…ë¡œë“œë˜ì—ˆì„ ê²½ìš° ë°ì´í„° ë³‘í•©
#     if sales_file and master_file:
#         try:
#             # íŒŒì¼ì—ì„œ ë°ì´í„° ì½ê¸°
#             sales_df = pd.read_excel(sales_file)
# 
#             # ë§ˆìŠ¤í„° íŒŒì¼ì—ì„œ 'ë§¤ì¶œì²˜'ì™€ 'í’ˆëª©' ì‹œíŠ¸ ë¡œë“œ
#             vendor_master = pd.read_excel(master_file, sheet_name='ë§¤ì¶œì²˜')
#             item_master = pd.read_excel(master_file, sheet_name='í’ˆëª©')
# 
#             # 'ë§¤ì¶œì¼' ì»¬ëŸ¼ì´ ìžˆëŠ”ì§€ í™•ì¸í•˜ê³ , ìžˆìœ¼ë©´ ë‚ ì§œ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
#             if 'ë§¤ì¶œì¼' in sales_df.columns:
#                 sales_df['ë§¤ì¶œì¼'] = pd.to_datetime(sales_df['ë§¤ì¶œì¼'])
# 
#                 # 'ë§¤ì¶œì²˜' ì‹œíŠ¸ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë³‘í•©í•˜ì—¬ ê±°ëž˜ì²˜êµ¬ë¶„ ì»¬ëŸ¼ ì¶”ê°€
#                 merged_df = pd.merge(sales_df, vendor_master, on='ë§¤ì¶œì²˜', how='left')
# 
#                 # 'í’ˆëª©' ì‹œíŠ¸ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë³‘í•©í•˜ì—¬ í’ˆëª©êµ¬ë¶„ ì»¬ëŸ¼ ì¶”ê°€
#                 merged_df = pd.merge(merged_df, item_master, on='í’ˆëª©', how='left')
# 
#                 # ë°ì´í„° ë§ˆì§€ë§‰ í–‰ ì‚­ì œ (ì˜ë¯¸ ì—†ëŠ” í•©ê³„ í–‰ ë“±ì„ ì œê±°í•˜ê¸° ìœ„í•¨)
#                 merged_df = merged_df.iloc[:-1]
# 
#                 # ë¶ˆí•„ìš”í•œ ì»¬ëŸ¼ ë¦¬ìŠ¤íŠ¸ ì •ì˜ (ê¸°ì¡´ê³¼ ì¶”ê°€ ìš”ì²­ëœ ì»¬ëŸ¼ ëª¨ë‘ í¬í•¨)
#                 unnecessary_cols = [
#                     'ì œí’ˆêµ°','ì†¡ìž¥ë²ˆí˜¸','í—¤ë”ë¹„ê³ ','ê·œê²©','ë¶€ê°€ì„¸í¬í•¨ë‹¨ê°€','ì˜ì—…ë‹´ë‹¹ìž','ì˜ì—…ë‹´ë‹¹ìžëª…','WBSëª…','ê±°ëž˜ì²˜ì†Œë¶„ë¥˜','ë¶€ê°€ì„¸í¬í•¨ê¸ˆì•¡','ìˆ˜ì£¼í—¤ë”ë¹„ê³ ','ìˆ˜ì£¼ë¼ì¸ë¹„ê³ ','B/Lë²ˆí˜¸','L/Cë²ˆí˜¸','ìˆ˜ì¶œì‹ ê³ ë²ˆí˜¸',
#                     'ë§¤ì¶œìœ í˜•','ë§¤ì¶œìƒíƒœ','ì˜ì—…ë¬¸ì„œë²”ì£¼ì½”ë“œ','íŒë§¤ë‹¨ìœ„','ì˜ì—…ì¡°ì§','ì‚¬ì—…ë¶€','ìˆ˜ì£¼ìˆœë²ˆ','ë‚©í’ˆì¼ì •ìˆœë²ˆ','ì¶œê³ ìˆœë²ˆ','ë¹„ìš©ì„¼í„°','ì±„ê¶Œ ì „í‘œ ìƒíƒœ','ì„¸ë¬´ë¶„ë¥˜','ë¶€ê°€ì„¸ì‚¬ì—…ìž¥',
#                     'ë‚©í’ˆì²˜','ë‚©í’ˆì²˜ëª…','ê³µìž¥','ë¹„ê³ ','ìˆ˜ê¸ˆì²˜','ìˆ˜ê¸ˆì²˜ëª…','ê²°ì œì¡°ê±´','ìˆ˜ê¸ˆì˜ˆì •ì¼','ê³ ê°ìžìž¬ì½”ë“œ','ê³ ê°ìžìž¬ì½”ë“œëª…', 'SETëª¨í’ˆëª©', 'WBSë²ˆí˜¸','ìˆ˜ì£¼ë²ˆí˜¸','ì¶œê³ ì¼','ì†ìµì „í‘œë²ˆí˜¸','ë‚©í’ˆì§€ì‹œë²ˆí˜¸',
#                     'í’ˆëª©ë²”ì£¼','ì¶œê³ ë²ˆí˜¸','ë§¤ì¶œìˆœë²ˆ', 'No','ë§¤ì¶œë²ˆí˜¸',
#                     'ìº”ìˆ˜ëŸ‰', 'ìº” ë³„ ê¸ˆì•¡', 'ìº” ë³„ ìž¥ë¶€ê¸ˆì•¡', 'í’ˆëª©ì œí’ˆêµ°',
#                     'ì„¸ë¬´êµ¬ë¶„', 'ëŒ€ë¶„ë¥˜', 'ì¤‘ë¶„ë¥˜', 'ì†Œë¶„ë¥˜', 'ìœ í†µê²½ë¡œ', 'ìˆ˜ë¶ˆìœ í˜•', 'í’ˆëª©ê³„ì •', 'ìˆ˜ì£¼ìœ í˜•', 'ê³ ê°ê·¸ë£¹', 'í•´ì™¸ê±°ëž˜ì²˜êµ¬ë¶„',
#                     'ë§¤ì¶œì²˜ëª…_x', 'ë§¤ì¶œì²˜ëª…_y', 'í’ˆëª©ëª…_x', 'í’ˆëª©ëª…_y'
#                 ]
# 
#                 # ë¶ˆí•„ìš”í•œ ì»¬ëŸ¼ì„ í•œ ë²ˆì— ì‚­ì œ (ì˜¤ë¥˜ ë°©ì§€ë¥¼ ìœ„í•´ `errors='ignore'` ì˜µì…˜ ì‚¬ìš©)
#                 merged_df = merged_df.drop(columns=unnecessary_cols, errors='ignore')
#                 st.success("ë‘ íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ë³‘í•©ë˜ì—ˆìœ¼ë©°, ë¶ˆí•„ìš”í•œ ì»¬ëŸ¼ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤!")
# 
#                 st.session_state.current_df = merged_df
#             else:
#                 st.warning("ì—…ë¡œë“œëœ ë§¤ì¶œ ë¦¬ìŠ¤íŠ¸ íŒŒì¼ì— 'ë§¤ì¶œì¼' ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”.")
#         except Exception as e:
#             st.error(f"íŒŒì¼ì„ ì²˜ë¦¬í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}. ì˜¬ë°”ë¥¸ ì—‘ì…€ íŒŒì¼ì¸ì§€, ê·¸ë¦¬ê³  'ë§ˆìŠ¤í„° íŒŒì¼'ì— 'ë§¤ì¶œì²˜'ì™€ 'í’ˆëª©' ì‹œíŠ¸ê°€ í¬í•¨ë˜ì–´ ìžˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.")
#             st.session_state.current_df = pd.DataFrame()
# 
#     # ìµœì¢… ë°ì´í„°í”„ë ˆìž„ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì¶”ê°€
#     if not st.session_state.current_df.empty:
#         # Excel íŒŒì¼ì„ ìœ„í•œ BytesIO ë²„í¼ ìƒì„±
#         output = io.BytesIO()
#         st.session_state.current_df.to_excel(output, index=False, engine='openpyxl')
#         output.seek(0)
# 
#         st.download_button(
#             label="ìµœì¢… ë°ì´í„° ë‹¤ìš´ë¡œë“œ (xlsx)",
#             data=output,
#             file_name="ë§¤ì¶œ_ë¶„ì„_ë°ì´í„°.xlsx",
#             mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
#         )
# 
#     # 'df' ë³€ìˆ˜ê°€ í•­ìƒ ì •ì˜ë˜ë„ë¡ ìˆ˜ì •
#     if 'current_df' in st.session_state and not st.session_state.current_df.empty:
#         df = st.session_state.current_df
#     else:
#         df = pd.DataFrame()
# 
# 
# # 2. ë°ì´í„°í”„ë ˆìž„ì´ ìžˆì„ ë•Œë§Œ ëŒ€ì‹œë³´ë“œ ë‚´ìš© í‘œì‹œ
# if not df.empty:
#     # 'ë§¤ì¶œì¼' ì»¬ëŸ¼ì—ì„œ ê³ ìœ í•œ ì—°ì›”ë§Œ ì¶”ì¶œ
#     unique_dates = sorted(df['ë§¤ì¶œì¼'].dt.to_period('M').unique())
#     date_options = [str(d) for d in unique_dates]
# 
#     # ì‚¬ì´ë“œë°”ì— ê¸°ê°„ ì„ íƒ ìœ„ì ¯ ì¶”ê°€
#     with st.sidebar:
#         selected_base_month = st.selectbox("ê¸°ì¤€ ì—°ì›” ì„ íƒ", options=date_options)
#         selected_compare_month = st.selectbox("ë¹„êµ ì—°ì›” ì„ íƒ", options=date_options)
# 
#     # ë©”ì¸ í™”ë©´ ì»¬ëŸ¼ êµ¬ì„±
#     col1, col2, col3 = st.columns([1, 2, 2]) # 1:2:2 ë¹„ìœ¨ë¡œ 3ê°œ ì»¬ëŸ¼ ìƒì„±
# 
#     # 2-1. ì¹¼ëŸ¼1: ì£¼ìš” ì§€í‘œ
#     with col1:
#         st.header("ì£¼ìš” ì§€í‘œ")
# 
#         # ê¸°ì¤€ì—°ì›”ê³¼ ë¹„êµì—°ì›” ë°ì´í„° í•„í„°ë§
#         base_month_sales = df[df['ë§¤ì¶œì¼'].dt.to_period('M') == selected_base_month]['ìž¥ë¶€ê¸ˆì•¡'].sum()
#         compare_month_sales = df[df['ë§¤ì¶œì¼'].dt.to_period('M') == selected_compare_month]['ìž¥ë¶€ê¸ˆì•¡'].sum()
# 
#         # ë°±ë§Œì› ë‹¨ìœ„ë¡œ ë³€í™˜
#         base_sales_million = base_month_sales / 1_000_000
#         compare_sales_million = compare_month_sales / 1_000_000
#         delta_sales_million = base_sales_million - compare_sales_million
# 
#         # delta_colorë¥¼ ì¡°ê±´ì— ë”°ë¼ ì„¤ì •
#         delta_sales_color = "normal" if delta_sales_million >= 0 else "inverse"
# 
#         st.markdown("#### ì´ ë§¤ì¶œì•¡")
#         st.metric(
#             label=f"{selected_base_month} ì´ë§¤ì¶œì•¡",
#             value=f"{base_sales_million:,.0f} ë°±ë§Œì›",
#             delta=f"{delta_sales_million:,.0f} ë°±ë§Œì›",
#             delta_color=delta_sales_color
#         )
# 
#         # ì¦ê°ìœ¨ ê³„ì‚°
#         if compare_month_sales != 0:
#             growth_rate = (base_month_sales - compare_month_sales) / compare_month_sales * 100
#             st.markdown(f"**ë¹„êµ ì—°ì›” ëŒ€ë¹„ ì¦ê°ìœ¨**: {growth_rate:.2f}%")
#         else:
#             st.markdown(f"**ë¹„êµ ì—°ì›” ëŒ€ë¹„ ì¦ê°ìœ¨**: -")
# 
# 
#         # ë‹¬ëŸ¬ ë§¤ì¶œì•¡ (í™˜ìœ„í—˜ ê´€ë¦¬ìš©)
#         st.markdown("---")
#         st.markdown("#### ë‹¬ëŸ¬ ë§¤ì¶œì•¡")
# 
#         # 'ê¸°ì¤€ ì—°ì›”'ê³¼ 'ë¹„êµ ì—°ì›”'ì— í•´ë‹¹í•˜ëŠ” 'íŒë§¤ê¸ˆì•¡' í•„í„°ë§ ë° í•©ê³„ ê³„ì‚° (ê±°ëž˜í†µí™”ê°€ 'USD'ì¸ ê²½ìš°ë§Œ)
#         base_month_usd_sales = df[(df['ë§¤ì¶œì¼'].dt.to_period('M') == selected_base_month) & (df['ê±°ëž˜í†µí™”'] == 'USD')]['íŒë§¤ê¸ˆì•¡'].sum()
#         compare_month_usd_sales = df[(df['ë§¤ì¶œì¼'].dt.to_period('M') == selected_compare_month) & (df['ê±°ëž˜í†µí™”'] == 'USD')]['íŒë§¤ê¸ˆì•¡'].sum()
# 
#         # ë°±ë§Œ ë‹¬ëŸ¬ ë‹¨ìœ„ë¡œ ë³€í™˜
#         base_usd_sales_million = base_month_usd_sales / 1_000_000
#         compare_usd_sales_million = compare_month_usd_sales / 1_000_000
#         delta_usd_sales_million = base_usd_sales_million - compare_usd_sales_million
# 
#         # delta_colorë¥¼ ì¡°ê±´ì— ë”°ë¼ ì„¤ì •
#         delta_usd_color = "normal" if delta_usd_sales_million >= 0 else "inverse"
# 
#         st.metric(
#             label=f"{selected_base_month} ë‹¬ëŸ¬ ë§¤ì¶œì•¡",
#             value=f"${base_usd_sales_million:,.2f} M",
#             delta=f"${delta_usd_sales_million:,.2f} M",
#             delta_color=delta_usd_color
#         )
# 
#         # ì¦ê°ìœ¨ ê³„ì‚°
#         if compare_month_usd_sales != 0:
#             usd_growth_rate = (base_month_usd_sales - compare_month_usd_sales) / compare_month_usd_sales * 100
#             st.markdown(f"**ë¹„êµ ì—°ì›” ëŒ€ë¹„ ì¦ê°ìœ¨**: {usd_growth_rate:.2f}%")
#         else:
#             st.markdown(f"**ë¹„êµ ì—°ì›” ëŒ€ë¹„ ì¦ê°ìœ¨**: -")
# 
# 
#     # 2-2. ì¹¼ëŸ¼2: ì›”ë³„ ë§¤ì¶œì•¡ ì¶”ì´ ë° êµ­ê°€ë³„ ë§¤ì¶œì•¡ í˜„í™©
#     with col2:
#         st.header("ì›”ë³„ ë§¤ì¶œì•¡ ì¶”ì´")
#         # ì›”ë³„ ë§¤ì¶œì•¡ í•©ê³„ ê³„ì‚°
#         monthly_sales = df.groupby(df['ë§¤ì¶œì¼'].dt.to_period('M'))['ìž¥ë¶€ê¸ˆì•¡'].sum().reset_index()
#         monthly_sales['ë§¤ì¶œì¼'] = monthly_sales['ë§¤ì¶œì¼'].astype(str)
# 
#         # ì„¸ë¡œ ë§‰ëŒ€ ì°¨íŠ¸ ìƒì„±
#         fig = px.bar(
#             monthly_sales,
#             x='ë§¤ì¶œì¼',
#             y='ìž¥ë¶€ê¸ˆì•¡',
#             title="ì›”ë³„ ë§¤ì¶œì•¡ ë³€í™” ì¶”ì´(ì „ì²´ ê¸°ê°„)",
#             color_discrete_sequence=['red'] # ë§‰ëŒ€ ìƒ‰ìƒ ë¹¨ê°„ìƒ‰
#         )
#         st.plotly_chart(fig, use_container_width=True)
# 
# 
# 
#         # ---
#         # í’ˆëª©ë³„ ì›”ë³„ ë§¤ì¶œì•¡ ì¶”ì´ êº¾ì€ì„  ê·¸ëž˜í”„ ì¶”ê°€
#         st.markdown("#### ì£¼ìš” í’ˆëª© ì›”ë³„ ë§¤ì¶œì•¡ ì¶”ì´")
# 
#         # ë¶„ì„ ëŒ€ìƒ í’ˆëª© ë¦¬ìŠ¤íŠ¸
#         target_items = ['PCpZr', 'CpHf', 'CpZr', 'HCDS']
# 
#         # 'Subject(PPT_ë³´ê³ ìš©)' ì»¬ëŸ¼ì˜ ê°’ì´ ëŒ€ìƒ í’ˆëª©ì— í¬í•¨ë˜ëŠ” ë°ì´í„°ë§Œ í•„í„°ë§
#         filtered_df = df[df['Subject(PPT_ë³´ê³ ìš©)'].isin(target_items)].copy()
# 
#         # ì›”ë³„ í’ˆëª©ë³„ ë§¤ì¶œì•¡ í•©ê³„ ê³„ì‚°
#         item_monthly_sales = filtered_df.groupby(
#             [filtered_df['ë§¤ì¶œì¼'].dt.to_period('M'), 'Subject(PPT_ë³´ê³ ìš©)']
#         )['ìž¥ë¶€ê¸ˆì•¡'].sum().reset_index()
# 
#         # 'ë§¤ì¶œì¼' ì»¬ëŸ¼ì„ ë¬¸ìžì—´ë¡œ ë³€í™˜í•˜ì—¬ ì‹œê°í™”ì— ìš©ì´í•˜ê²Œ ë§Œë“¦
#         item_monthly_sales['ë§¤ì¶œì¼'] = item_monthly_sales['ë§¤ì¶œì¼'].astype(str)
# 
#         # êº¾ì€ì„  ê·¸ëž˜í”„ ìƒì„±
#         fig_items_trend = px.line(
#             item_monthly_sales,
#             x='ë§¤ì¶œì¼',
#             y='ìž¥ë¶€ê¸ˆì•¡',
#             color='Subject(PPT_ë³´ê³ ìš©)', # í’ˆëª©ë³„ë¡œ ë‹¤ë¥¸ ì„ ì„ ê·¸ë¦¬ê¸° ìœ„í•´ color ì‚¬ìš©
#             title="ì£¼ìš” í’ˆëª© ì›”ë³„ ë§¤ì¶œì•¡ ë³€í™” ì¶”ì´(ì „ì²´ ê¸°ê°„)"
#         )
# 
#         # ì°¨íŠ¸ í‘œì‹œ
#         st.plotly_chart(fig_items_trend, use_container_width=True)
# 
# 
#         # ---
#         # êµ­ê°€ë³„ ë§¤ì¶œì•¡ ë²„ë¸” ì§€ë„ ì°¨íŠ¸ ì¶”ê°€
#         st.markdown("#### êµ­ê°€ë³„ ë§¤ì¶œì•¡ (ì§€ë„)")
# 
#         # êµ­ê°€ëª…ê³¼ ISO ì½”ë“œ ë§¤í•‘ ë”•ì…”ë„ˆë¦¬ (í•„ìš”ì— ë”°ë¼ ì¶”ê°€/ìˆ˜ì • ê°€ëŠ¥)
#         country_iso_map = {
#             'ëŒ€í•œë¯¼êµ­': 'KOR',
#             'ë¯¸êµ­': 'USA',
#             'ì¤‘êµ­': 'CHN',
#             'ì¼ë³¸': 'JPN',
#             'í˜¸ì£¼': 'AUS',
#             'íƒœêµ­': 'THA',
#             'ë§ë ˆì´ì‹œì•„': 'MYS',
#             'ì¸ë„ë„¤ì‹œì•„': 'IDN',
#             'ì¸ë„': 'IND',
#             'í•„ë¦¬í•€': 'PHL',
#             'ë² íŠ¸ë‚¨': 'VNM',
#             'ìºë‚˜ë‹¤': 'CAN',
#             'ë©•ì‹œì½”': 'MEX',
#             'ë¸Œë¼ì§ˆ': 'BRA',
#             'ì˜êµ­': 'GBR',
#             'ë…ì¼': 'DEU',
#             'í”„ëž‘ìŠ¤': 'FRA',
#             'ì´íƒˆë¦¬ì•„': 'ITA',
#             'ìŠ¤íŽ˜ì¸': 'ESP',
#             'ëŸ¬ì‹œì•„': 'RUS',
#             'ì‹±ê°€í¬ë¥´': 'SGP',
#             'ëŒ€ë§Œ': 'TWN',
#             'ë²¨ê¸°ì—': 'BEL',
#             'í•€ëž€ë“œ': 'FIN'
#         }
# 
#         # êµ­ê°€ë³„ ë§¤ì¶œì•¡ í•©ê³„ ê³„ì‚° (ì „ì²´ ê¸°ê°„ ë°ì´í„° ì‚¬ìš©)
#         country_sales = df.groupby('êµ­ê°€êµ¬ë¶„')['ìž¥ë¶€ê¸ˆì•¡'].sum().reset_index()
# 
#         # ISO ì½”ë“œ ì»¬ëŸ¼ ì¶”ê°€ (ë§¤í•‘ ë”•ì…”ë„ˆë¦¬ ì‚¬ìš©)
#         country_sales['iso_alpha'] = country_sales['êµ­ê°€êµ¬ë¶„'].map(country_iso_map)
# 
#         # ISO ì½”ë“œê°€ ì—†ëŠ” ë°ì´í„°ëŠ” ì œì™¸
#         country_sales.dropna(subset=['iso_alpha'], inplace=True)
# 
#         # ë¡œê·¸ ë³€í™˜ (ë” í° ì°¨ì´ ì¡°ì ˆ ê°€ëŠ¥)
#         country_sales['size_scaled'] = np.log1p(country_sales['ìž¥ë¶€ê¸ˆì•¡'])
# 
#         # ë²„ë¸” ì§€ë„ ì°¨íŠ¸ ìƒì„±
#         fig_map = px.scatter_geo(
#             country_sales,
#             locations="iso_alpha",
#             size="size_scaled", # ë²„ë¸” í¬ê¸°ë¥¼ ì¡°ì •(ë¡œê·¸ ë³€í™˜ ì»¬ëŸ¼ ì‚¬ìš©)
#             color="ìž¥ë¶€ê¸ˆì•¡",  # ì—¬ê¸°ì— ìƒ‰ìƒì„ ì¤„ ë°ì´í„° ì»¬ëŸ¼ì„ ì§€ì •
#             color_continuous_scale=px.colors.sequential.Plasma, # ìƒ‰ìƒ íŒ”ë ˆíŠ¸ ì§€ì •
#             hover_name="êµ­ê°€êµ¬ë¶„",
#             projection="natural earth",
#             title=f"êµ­ê°€ë³„ ë§¤ì¶œì•¡ ì§€ë„(ì „ì²´ ê¸°ê°„)",
#             template="plotly", # 'plotly_dark'ë¥¼ 'plotly'ë¡œ ë³€ê²½í•˜ì—¬ ë°ì€ ë°°ê²½ìœ¼ë¡œ ê°œì„ 
#             # color_discrete_sequence=["red"], # ë²„ë¸”ì˜ ìƒ‰ìƒì„ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ ì§€ì •
#             size_max=60   # ìµœëŒ€ ë²„ë¸” í¬ê¸° í‚¤ìš°ê¸°
#         )
# 
#         # ì§€ë„ í•´ìƒë„ ì„¤ì • ì¶”ê°€
#         fig_map.update_layout({
#             'geo': {
#                 'resolution': 50
#             }
#         })
# 
# 
#         # ì°¨íŠ¸ í‘œì‹œ
#         st.plotly_chart(fig_map, use_container_width=True)
# 
# 
#     # 2-3. ì¹¼ëŸ¼3: ê±°ëž˜ì²˜/í’ˆëª©ë³„ ë§¤ì¶œ Top5
#     with col3:
#         st.header("Top 5 í•­ëª©")
# 
#         # ê¸°ì¤€ ì—°ì›”ê³¼ ë¹„êµ ì—°ì›” ë°ì´í„° í•„í„°ë§
#         base_df = df[df['ë§¤ì¶œì¼'].dt.to_period('M') == selected_base_month].copy()
#         base_df['ê¸°ê°„'] = selected_base_month
#         compare_df = df[df['ë§¤ì¶œì¼'].dt.to_period('M') == selected_compare_month].copy()
#         compare_df['ê¸°ê°„'] = selected_compare_month
# 
#         combined_df = pd.concat([base_df, compare_df])
# 
#         # ë°ì´í„°ê°€ ì—†ì„ ê²½ìš° ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
#         if combined_df.empty:
#             st.warning("ì„ íƒí•œ ê¸°ê°„ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ê¸°ê°„ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.")
#         else:
#             # ìƒ‰ìƒ ë§µ ì •ì˜
#             color_map = {
#                 selected_base_month: '#004488',
#                 selected_compare_month: '#C8C8C8'
#             }
# 
#             # ì „ì²´ ë°ì´í„°ì—ì„œ Top 5 í•­ëª© ì„ ì • (ê¸°ì¤€ ì—°ì›” ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬)
#             top_5_vendors_base = base_df.groupby('ê±°ëž˜ì²˜êµ¬ë¶„(PPT_ë³´ê³ ìš©)')['ìž¥ë¶€ê¸ˆì•¡'].sum().nlargest(5).index
#             top_5_items_base = base_df.groupby('Subject(PPT_ë³´ê³ ìš©)')['ìž¥ë¶€ê¸ˆì•¡'].sum().nlargest(5).index
# 
#             # ê±°ëž˜ì²˜ë³„ ë§¤ì¶œì•¡ ìƒìœ„ Top5 (ë‘ ê¸°ê°„ ë¹„êµ)
#             st.markdown("##### ê±°ëž˜ì²˜ë³„ ë§¤ì¶œì•¡ ìƒìœ„ 5 (ë‘ ê¸°ê°„ ë¹„êµ)")
#             vendor_sales_chart = combined_df[combined_df['ê±°ëž˜ì²˜êµ¬ë¶„(PPT_ë³´ê³ ìš©)'].isin(top_5_vendors_base)]
#             vendor_sales_chart = vendor_sales_chart.groupby(
#                 ['ê¸°ê°„', 'ê±°ëž˜ì²˜êµ¬ë¶„(PPT_ë³´ê³ ìš©)']
#             )['ìž¥ë¶€ê¸ˆì•¡'].sum().reset_index()
# 
#             # ê¸°ì¤€ ì—°ì›” ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
#             vendor_order = vendor_sales_chart[vendor_sales_chart['ê¸°ê°„'] == selected_base_month].sort_values(by='ìž¥ë¶€ê¸ˆì•¡', ascending=False)['ê±°ëž˜ì²˜êµ¬ë¶„(PPT_ë³´ê³ ìš©)']
# 
#             fig_vendor = px.bar(
#                 vendor_sales_chart,
#                 x='ìž¥ë¶€ê¸ˆì•¡',
#                 y='ê±°ëž˜ì²˜êµ¬ë¶„(PPT_ë³´ê³ ìš©)',
#                 color='ê¸°ê°„',
#                 barmode='group',
#                 orientation='h',
#                 category_orders={"ê±°ëž˜ì²˜êµ¬ë¶„(PPT_ë³´ê³ ìš©)": list(vendor_order)},
#                 color_discrete_map=color_map, # ìƒ‰ìƒ ë§µ ì ìš©
#                 title="ê±°ëž˜ì²˜ë³„ ë§¤ì¶œ Top 5"
#             )
#             st.plotly_chart(fig_vendor, use_container_width=True)
# 
#             # í’ˆëª©ë³„ ë§¤ì¶œì•¡ ìƒìœ„ Top5 (ë‘ ê¸°ê°„ ë¹„êµ)
#             st.markdown("##### í’ˆëª©ë³„ ë§¤ì¶œì•¡ ìƒìœ„ 5 (ë‘ ê¸°ê°„ ë¹„êµ)")
#             item_sales_chart = combined_df[combined_df['Subject(PPT_ë³´ê³ ìš©)'].isin(top_5_items_base)]
#             item_sales_chart = item_sales_chart.groupby(
#                 ['ê¸°ê°„', 'Subject(PPT_ë³´ê³ ìš©)']
#             )['ìž¥ë¶€ê¸ˆì•¡'].sum().reset_index()
# 
#             # ê¸°ì¤€ ì—°ì›” ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
#             item_order = item_sales_chart[item_sales_chart['ê¸°ê°„'] == selected_base_month].sort_values(by='ìž¥ë¶€ê¸ˆì•¡', ascending=False)['Subject(PPT_ë³´ê³ ìš©)']
# 
#             fig_item = px.bar(
#                 item_sales_chart,
#                 x='ìž¥ë¶€ê¸ˆì•¡',
#                 y='Subject(PPT_ë³´ê³ ìš©)',
#                 color='ê¸°ê°„',
#                 barmode='group',
#                 orientation='h',
#                 category_orders={"Subject(PPT_ë³´ê³ ìš©)": list(item_order)},
#                 color_discrete_map=color_map, # ìƒ‰ìƒ ë§µ ì ìš©
#                 title="í’ˆëª©ë³„ ë§¤ì¶œ Top 5"
#             )
#             st.plotly_chart(fig_item, use_container_width=True)
# 
#             # ---
#             # êµ­ê°€ë³„ ë§¤ì¶œì•¡ íŒŒì´ ì°¨íŠ¸ ì¶”ê°€
#             st.markdown("#### êµ­ê°€ë³„ ë§¤ì¶œì•¡ ë¹„ì¤‘")
# 
#             # ê¸°ì¤€ ì—°ì›” ë°ì´í„°ë§Œ í•„í„°ë§
#             base_df_country_sales = df[df['ë§¤ì¶œì¼'].dt.to_period('M') == selected_base_month].copy()
# 
#             # 'êµ­ê°€êµ¬ë¶„' ì»¬ëŸ¼ìœ¼ë¡œ ê·¸ë£¹í™”í•˜ì—¬ ë§¤ì¶œì•¡ í•©ê³„ ê³„ì‚°
#             country_sales = base_df_country_sales.groupby('êµ­ê°€êµ¬ë¶„')['ìž¥ë¶€ê¸ˆì•¡'].sum().reset_index()
# 
#             # ë§¤ì¶œì•¡ ê¸°ì¤€ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
#             country_sales = country_sales.sort_values(by='ìž¥ë¶€ê¸ˆì•¡', ascending=False)
# 
#             # íŒŒì´ ì°¨íŠ¸ ìƒì„± (ë„ë„› ì°¨íŠ¸ë¡œ ë§Œë“¤ê¸° ìœ„í•´ hole íŒŒë¼ë¯¸í„° ì‚¬ìš©)
#             fig_country = px.pie(
#                 country_sales,
#                 values='ìž¥ë¶€ê¸ˆì•¡',
#                 names='êµ­ê°€êµ¬ë¶„',
#                 title=f'{selected_base_month} êµ­ê°€ë³„ ë§¤ì¶œì•¡ ë¹„ì¤‘',
#                 hole=0.5  # ë„ë„› ëª¨ì–‘ì„ ìœ„í•œ hole ì„¤ì •
#             )
# 
#             # ì°¨íŠ¸ í‘œì‹œ
#             st.plotly_chart(fig_country, use_container_width=True)

import os
from pyngrok import ngrok

# ì—¬ê¸°ì— ë°œê¸‰ë°›ì€ ì‹¤ì œ í† í°ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
ngrok_token = "31tQ7vgtLDWYnSCoFpbcEWyYynT_6k9LBhyMBVwBwPojUzpct"
os.environ["NGROK_AUTH_TOKEN"] = ngrok_token
ngrok.set_auth_token(ngrok_token)

public_url = ngrok.connect(8501)
print("Streamlit ì•± ì£¼ì†Œ:", public_url)

!streamlit run app.py &>/dev/null&